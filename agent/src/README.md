# sawdust-agent

## What this agent does
This agent enables a compute node to communicate with the sawdust control plane.  This includes:
1.  Sending a registration request to the control plane.  This request payload must include the secret key for the workflow being operated on, and shares credentials with the control plane that will be used to push work to the node.
2.  Starts a listener that accepts requests from the control plane.  These requests will include workflow metadata that the host should process.
3.  Calls worker process to perform work
4.  Sends result back to control plane.

## How to run:
The agent requires several command line parameters on startup:

* `endpoint` - the control plane endpoint
* `workflow_id` - the workflow that the current compute node should register with.  This is generated by the control plane when the workflow is created
* `workflow_token` - secret token for the workflow that the current compute node should register with.  This is generated by the control plane when the workflow is created.
* `certificate_path` - route to a .pem certificate file that should be used to establish an SSL handshake with the control plane
* `listener_port` - the port that the agent should listen on


Example:
```bash
cargo run -- http://localhost:8080 test Pw4uRBrb_i9sljeFJDhVLLSNSYJZ1m_iTfo_ybA4FGoA8W0QLPEpR0yCAjVF_WqL /Users/connor/code/sawdust/agent/certificate.pem 9000
```

## Contracts
This agent and the Sawdust control plane need to communicate to exchange activities.

### Registration
On startup, the agent sends a request to the control plane to register as a compute node.  This request takes a JSON body:
```json
{
    "workflowId": "string",
    "workflowToken": "string",
    "certificate": "string"
}
```

### PushActivity
Once an agent is registered and running, the control plane should periodically push activities to the agent to be processed.  This request takes a JSON body:
```json
{
    "computeId": "string",
    "activity": {
        "activityId": "string",
        "workflowName": "string",
        "workflowState": "string"
    }
}
```
